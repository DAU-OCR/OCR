# CRAFT 전처리 스크립트 개선 사항 (2025-07-07)

## 1. 개요

`ocr/scripts/preprocess_craft_split.py` 스크립트는 CRAFT 텍스트 탐지 결과를 바탕으로 CRNN 모델 학습용 데이터셋을 생성하는 역할을 한다. 초기 버전은 문자 단위로 분할하는 방식이었으나, 다양한 번호판 형태에 대응하고 데이터 품질을 높이기 위해 **단어/그룹 단위**로 이미지를 저장하고, 발생하는 여러 예외 케이스를 지능적으로 처리하도록 로직을 대폭 수정했다.

---

## 2. 핵심 변경 사항

### 가. 기본 동작: 단어/그룹 단위 데이터 생성

- 기존의 문자 단위 분할 로직(`split_box`)을 폐기했다.
- 라벨 파일(`*.txt`)에 명시된 텍스트를 공백 기준으로 분리 (예: `"12가 3456"` -> `['12가', '3456']`).
- CRAFT가 탐지한 텍스트 박스와 분리된 라벨 단어를 1:1로 매칭하여 이미지와 라벨 파일을 생성한다.
- 저장 경로는 `data/word_images/` 및 `data/word_labels/`로 변경되었다.

### 나. 지능적 예외 처리 로직 추가

#### 1) 노이즈성 박스 자동 필터링
- **문제**: CRAFT가 라벨에 명시된 단어 수보다 많은 박스를 탐지하는 경우 (주로 볼트, 얼룩 등 노이즈). 
- **해결**: 감지된 박스들의 **면적(area)**을 계산하여 가장 큰 박스들만 라벨의 단어 수만큼 남기고, 작은 노이즈성 박스들은 자동으로 폐기한다.
  - 예: 라벨이 `['12가', '3456']` (2개)이고 박스가 3개 탐지되면, 가장 큰 2개만 선택한다.

#### 2) 단일 라벨-다중 박스 처리 (핵심 개선)
- **문제**: 라벨은 `"01버0273"`처럼 한 덩어리인데, CRAFT가 `"01버"`와 `"0273"` 두 개의 의미 있는 박스로 분리하여 탐지하는 경우.
- **해결**: 이 경우를 특별 케이스로 감지하여, **하나의 라벨을 두 박스의 너비 비율에 맞춰 자동으로 분할**한다. 이를 통해 버려지는 데이터 없이 학습 샘플을 2개로 늘릴 수 있다.
  - 예: `"01버0273"` -> `['01버', '0273']` 으로 자동 분할 후 각각의 박스와 매칭하여 저장한다.

---

## 3. 버그 수정 및 안정성 강화

- **기울기 보정 문제**: `deskew` 함수가 번호판 이미지를 세로로 세우는 문제를 일으켜, 해당 함수 호출부를 주석 처리하여 비활성화했다.
- **정렬 오류 수정**: 박스 필터링 로직에서 NumPy 배열에 `sort(key=...)`를 사용하여 발생하던 `TypeError`를 파이썬 내장 함수인 `sorted(..., key=...)`로 변경하여 해결했다.

